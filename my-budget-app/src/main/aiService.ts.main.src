import { net } from 'electron';

// Configuración para OLLAMA (Local)
const OLLAMA_URL = "http://localhost:11434/api/chat";
const MODEL_NAME = "llama3.2"; // El modelo que acabas de descargar

const BUDGETCAT_CATEGORIES = [
  "Personnel", 
  "Equipment", 
  "Travel", 
  "External Services", 
  "Office Costs", 
  "Other Direct Costs"
];

export async function analyzeBudgetRows(rows: any[]) {
  // Convertimos las filas a texto
  const dataString = JSON.stringify(rows);

  const prompt = `
    Analiza los siguientes datos crudos de un presupuesto (array de arrays).
    
    Tus tareas:
    1. Detecta filas que sean ITEMS DE COSTO (ignora cabeceras vacías o títulos).
    2. Extrae: Descripción, Categoría, Unidad, Cantidad, Costo Unitario y Total.
    3. Asigna la categoría más apropiada de esta lista: ${BUDGETCAT_CATEGORIES.join(", ")}.
    
    Datos:
    ${dataString}

    Responde ÚNICAMENTE un JSON válido con este formato:
    {
      "items": [
        { 
          "description": "Nombre del item", 
          "category": "Categoría", 
          "unit": "Unidad", 
          "quantity": 1, 
          "unit_cost": 100, 
          "total": 100 
        }
      ]
    }
  `;

  try {
    // Usamos fetch nativo (Node 18+ en Electron)
    const response = await fetch(OLLAMA_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: MODEL_NAME,
        messages: [{ role: "user", content: prompt }],
        format: "json", // Forzamos respuesta JSON
        stream: false   // Queremos toda la respuesta junta, no por partes
      })
    });

    if (!response.ok) {
      throw new Error(`Error Ollama: ${response.statusText}`);
    }

    const jsonResponse: any = await response.json();
    
    // El modelo devuelve el texto dentro de "message.content"
    const content = jsonResponse.message.content;
    
    // Parseamos el texto a JSON real
    const parsed = JSON.parse(content);
    return parsed.items || [];

  } catch (error) {
    console.error("Error consultando IA Local:", error);
    return []; 
  }
}